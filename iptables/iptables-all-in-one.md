# Iptables理论详解

Iptables主要由规则(Rule)，链(Clain)，和表(Table)组成。他们三者的关系相对简单：

1. Rule: 定义一个包含条件和动作的规则，当满足什么条件时，做什么；
2. Clain: 零个、一个或多个Rules的链表结构，按照链表的顺序，报文会被Rule进行处理；
3. Table: 多个Clain的集合。

接下来自下而上地依次讲解三个部分。

## 规则（Rules）

一个规则可以简单包括两个部分：“是不是”，“如果是的话干什么”。

### 条件（是不是）
假设我们自己就是Iptables，我们现在拿到了一个IPv4报文，我们就可以看到这个报文的所有信息，然后验证这个报文是否满足该条件。

例如：这个报文是不是来自于IP段1.2.3.0/24的？这个报文是不是一个TCP报文？

请重新查看下图，Iptable可以判断下图的所有条件：

![IPv4数据报文](./images/IPv4_Packet-en.svg)

此外，Iptables还可以判断这个报文是不是来自某个网卡，典型的网卡例子有:
1. `lo`: LoopBack，回环地址127.0.0.1；
2. `eth0,eth1`: 以太网网卡，也就是连外部网络的；
3. `docker0`: Docker自己创建的虚拟网卡等。

在这里插一句，对Linux而言，一切皆文件，网卡也不例外。只要有相应的驱动能够识别到这个网卡，此时，这个网卡就是一个简单的`FILE*`，可以`open(2)`，`write(2)`, `read(2)`，与普通的文本文件向磁盘写入字节稍微不同的是，`write(2)`代表向网卡写入字节，`read(2)`代表从网卡中读出字节，而这个字节一般都是网络报文的数据。

### 目标（如果达成了条件，则干什么）
当Iptables匹配到了该报文对该Rule的条件成立，那么就会执行该规则的目标(**Target**)。这些目标可以是：
1. ACCEPT： 接受，即允许数据包正常通过；
2. DROP：丢弃数据包而没有任何响应；
3. REJECT：拒绝该数据包，但是必要时会返回详细信息给源；
4. 转到用户定义的Clain中继续判定；
5. 其他被`iptables-extensions(8)`所定义的目标。

前面三个目标比较显而易懂，第四个目标我们暂时不做考虑，后面学习到Clain再做讲解。第五个目标是`iptables-extensions`，这类属于对iptables的拓展内容，不做深入的讲解。

### 使用一些例子来介绍规则
下面我将会使用一些简单的例子来做说明：

1. `DROP`来源IP段为`1.2.3.0/24`的TCP报文

```
iptables -A INPUT \
    -p tcp -s 1.2.3.0/24 -j DROP
```

第一行暂时跳过，我们从第二行开始。

首先，`-p`参数指明`Protocal`为TCP协议；`-s`指明`Source`，可以是IP段或IP地址，`-j`表示Target，这里是`DROP`.

当然，如果也可以使用`REJECT`。

2. `ACCEPT`来源IP为`1.2.3.4`的ssh报文，端口为2222。

```
iptables -A INPUT \
    -p tcp -s 1.2.3.4 --dport 2222 -j ACCEPT
```
第一行暂时跳过，我们仍然从第二行开始。

与第一个例子不同的是，使用`--dport`参数表明**目标端口**，注意这个**目标**其实就是当前主机。

## 链(Clains)

Rules是独立的，我们需要使用一种数据结构将独立的、离散的Rules组合起来。

Clain本质上是一个包含Rules的链表，这种Clain有五种：
1. INPUT链：处理来自外部的数据。我们在上一小节中就是用的这个作为例子。(`-A INPUT`，表示往`INPUT`追加规则)；
2. OUTPUT链：处理从内部发往外部的数据。
3. FORWARD链：将数据从一个网卡转发到其他的网卡上，以将这个数据包交付给本身或其他主机(主机和主机之间就是通过局域网的网卡通信)；
4. PREROUTING链：当报文到达时，尝试修改目标IP地址；
5. POSTROUTING链：当报文即将离开时，尝试修改源IP地址。

### Rules在Clain中的表现

我们不妨执行以下上一节中的两条语句：
```
iptables -A INPUT -p tcp -s 1.2.3.0/24 -j DROP
iptables -A INPUT -p tcp -s 1.2.3.4 --dport 2222 -j ACCEPT
```
